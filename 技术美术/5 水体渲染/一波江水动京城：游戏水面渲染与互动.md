

**1. 水面渲染**

1) 水体基础颜色混合

2) 法线

3) 折射

4) 焦散

5) 水体明暗

6) 反射

7) 高光

8) 点光源

**2. 水面互动**

1) 水波纹的生成

a. 扩散方程

b. 配置和流程

c. 白浪和泡沫的生成

2) 触发器的制作

a. 正确触发水波纹

b. 正确播放特效

# 水面渲染 


![[7f5656e2f9b97a38ae922a7ad433aee9_MD5.jpg]]


## **水体基础颜色混合**

第一步就是绘制水体颜色，水体基础颜色由以下几个参数决定

- 屏幕深度
- 浅水颜色
- 深水颜色
- 过渡深度
- 过渡系数

通过获取当前摄像机的深度图，再用配置好的深水浅水颜色，然后加上过度深度参数和过度系数以控制深水浅水颜色的融合，最终画出水体基础颜色。

用到的公式很简单

深度系数 = pow(saturate ( 屏幕深度 / 过渡深度), 过渡系数)

水体基础颜色 = lerp(浅水颜色, 深水颜色, 深度系数)

大致效果流程如图所示:

![[445f5227d9c67ca962b17ff4d9221cb2_MD5.png]]

![[5d0c4b5666d39abe1a3a6cff4342aa3a_MD5.png]]

![[5199f8eb3c4b5393771423db31f25e1e_MD5.jpg]]

### **法线**
<font color="#ff0000">这里我使用了 FFT 生成法线的方法</font>

第二步就是生成水面法线，法线是整个水面效果最重要的一部分，因为接下来的各种表现都会与法线效果相关。

我们尝试了两种方式来获取水面法线，**其中一种就是现在常用的解决方案，使用 fft 来生成水面高度图，然后来获取水面法线。**

效果如下所示：

![[be2a5aeebc587eea22c6ec47da4d6b04_MD5.jpg]]

重新播放

Fft 海洋 + 曲面细分 + 反射 + 高光 + 白浪

另外一种是通过变化 tiling、偏移和强度来多次采样一张法线贴图进行叠加，同时加上视差效果和风力对水面的影响来获取最终的水面法线。

知乎上面已经有较多介绍生成 fft 的文章了，这里就着重介绍第二种方法。

大致要素有：

l 法线贴图

l 叠加

l 视差

l 风力影响

首先是在 shader 里面获取到水面顶点的世界坐标再按一定的缩放比例，然后转换成采样的 uv 坐标并对法线贴图进行采样。注意，法线贴图的分辨率可以大一些，这里使用的法线贴图分辨率为 2048*2048。

![[584c17fed3a9705f4c5b92a8b155c6f1_MD5.png]]

这是进行叠加之后的效果：

![[d208fc050b17c5bf5733a700124c7f1e_MD5.png]]

添加上视差效果（也可以通过曲面细分，然后通过位移顶点位置来达到类似的效果）可以使水面更加立体。简单来说，视差效果就是让现实生活中应该看不到的地方在游戏里也看不到，尤其是在原本 mesh 就是平面的情况下，这会让表现效果更立体更真实。视差效果的技术细节就不赘述了，这里用到的就是浮雕视察映射，效果如下所示：

![[351ab582c9dd34c4c55176e6346345f2_MD5.png]]

最后添加风力对水面的影响，风力的做法目前也是通过采样法线贴图（不同的 tiling 和位移），然后通过一张 noise 贴图（或者算法生成）来进行强弱控制。最后叠加的效果如下所示：

![[4bde59f781bd401d9e9f30907677fd31_MD5.png]]

### **折射**
<font color="#ff0000">扰动屏幕 UV 来采样</font>

第三步制作折射效果，主要是以下四个部分：

l 颜色混合

l 位置偏移

l 随深度增强

l 处理边界

颜色混合如同水体颜色的浅水深水颜色混合，这里采用同样的方式，把之前计算出的水体颜色和水下原始颜色进行混合。

位置偏移就是将原先的水下颜色根据法线扰动屏幕采样坐标，从而得到最终扰动之后的颜色，再做一个**随深度扰动加强**的效果。**然后，还需要对扰动超出屏幕坐标范围的点进行规范。??**

大致效果如下

![[34a1273f3291ed962cd00a4d927c0606_MD5.png]]

### **焦散（鸽）**

**一般出现在靠近岸边的浅水区域，可以通过 projector 来生成，也可以直接画在水面上（如果镜头不会出现在水面以下）。**

本文将介绍一下画在水面上的方式，同时需要强调的是，目前游戏中生成的焦散并不是按照真实物理方式生成的。

主要有以下几个流程：

l 还原深度

l Tiling

l 颜色

l 自变化速度

l 受法线影响

l 亮度

首先，我们需要还原焦散位置。通过深度信息就能把原本在水表面的点还原到水底，然后根据还原的坐标带入焦散公式计算出焦散的颜色（所用到的公式可以参照 shadertoy 上的这个效果 [https://www.shadertoy.com/view/MdKXDm](https://www.shadertoy.com/view/MdKXDm)）。

很自然，我们会想到我们需要能控制焦散的 tiling、颜色、亮度、自变化速度、移动速度以及受法线影响的强度。

具体流程效果如下：

![[ff6c905244d2edda36f2d102525ca763_MD5.png]]

![[14ff384eb0ca79d8ff0d1ccd54d90176_MD5.png]]

![[f5c2c992d4da65c18059b8ec2c841b54_MD5.jpg]]

![[332c7b0a9f647ffb3fec0b62ad67a01b_MD5.jpg]]

![[87d7d31740a21a2a4157156101a0d6b7_MD5.png]]

![[450fae3480493845fa0b3b1d5037694e_MD5.jpg]]

### **水体明暗**

这是一个提升整体水面表现非常重要的效果，特别是在水面处于较暗的场景里，它的作用更加明显。现实生活中，**在暗处的水和在亮处的水的颜色肯定是不一样的。比如说，在阴影下的水就会更黑。**

我们目前的解决方案很粗暴，但是效果还不错，简单来说就是**通过获取当前摄像机的颜色贴图，然后对颜色贴图的亮度做一个高斯模糊<font color="#ff0000">（优化思路：改成双重模糊</font>），来作为当前水面的明暗贴图**。在水面 shader 里通过做折射的方式，采样这一张明暗贴图来对水面各种效果做一个亮度调整，比如反射、高光、水体颜色、焦散等，这些效果也都有一个参数**分别控制自身受影响的程度**，这样就得到了最终的水面颜色。

这是计算出的明暗贴图的效果

![[824f39c15412e86ce01616f70281feab_MD5.png]]

有无明暗贴图的一个效果

![[ab46e1c59771053f736c7cb695f079b7_MD5.png]]

![[10865acc37f63dc597229397738febf8_MD5.png]]

### 反射
TODO:SSR

目前使用的是屏幕空间反射技术来制作的游戏内水面的反射效果，具体流程如下

l 计算菲涅尔系数

l 屏幕空间反射获取反射颜色

l 特殊处理

屏幕空间反射的技术细节就不在这篇文章里面讲解了，感兴趣的同学可以参考知乎上相关的技术分享，简单来说可以理解为反射的颜色仅能是当前屏幕能看到的颜色，超过屏幕范围的颜色则通过传入进来的天空 cubemap 来作为填充，而后构成最终的反射效果。同时，我们也要考虑物件的厚度、mipmap、相机空间和屏幕空间步进长度转换等。

下面是反射的流程效果

![[51866a3acae904d4a13f761df12ea591_MD5.png]]

![[a28ab7013326bcf1520b966dd957323d_MD5.png]]

![[264b31ce62206e6ea40098bac7493850_MD5.jpg]]

![[264b31ce62206e6ea40098bac7493850_MD5.jpg]]

### **高光**

高光也是传统做法，由以下几个要素组成

l 范围

l 亮度

l 受法线影响

l 随视角扩散

通过光线方向视线方向和水面法线方向能够计算出高光系数，这个系数可以通过一个范围参数和一个强度参数控制整个高光的扩散范围和亮度，同时添加一个参数来增减高光扰动的强弱就可以使高光的强弱更加可控。最后，添加**随视角扩散参数**使离摄像机越远的高光扩散得越厉害。

流程效果如下图所示

![[8eeacb0cac8e16dabe0f9a116550bef8_MD5.png]]

![[091defc8c31fefd79349e94e7790f77e_MD5.png]]

![[aaa41791bdf233fcaf00d2c1508b6cc2_MD5.png]]

![[0cacad60f29a8692b11e52032985550d_MD5.jpg]]

![[4ca7801694ed7db363e7c4d496e9c707_MD5.png]]

![[281629681fc50f072845abca2b694dc3_MD5.jpg]]

![[a32eb817be2462cbbea42445debf32c3_MD5.png]]

### **点光源**

如果在较暗的环境里面有点光源，那么水面对点光源的反馈就显得尤为重要了。目前游戏里的水面并不是海洋那样一大片，而是一块一块的区域面片水，也就意味着每一个水面区域都分别有配置能影响他们的点光源。**点光源配置需要完全还原 unity 的点光源，参数有半径，强度，灯光颜色，或者在勾选了 temperature 之后调整光的 temperature 系数。最后，在水面上做出一个点光源范围光和点光源高光的效果。**

具体效果如下图所示

![[10865acc37f63dc597229397738febf8_MD5.png]]

![[e24ecd72fb3d96a157b45664eb75bca1_MD5.png]]

![[24295946c431f1af19e65fd4ca79283b_MD5.png]]

最后再补充一点，简单来说，目前会受到法线影响的效果都有各自的参数，分别控制受影响的强度，明暗度的控制也是一样，虽说这样做有 trick 的嫌疑，但是可以更精确的还原美术同学想要的表现效果。

**水面渲染最后效果**

![[85a484bf2f740eb86e608e4fa34850c2_MD5.jpg]]


# 水面互动

接下来是水面互动相关的内容，水面互动主要有水波纹的生成和触发器的制作两个部分。

**水波纹的生成**

**扩散方程**

目前游戏内生成的水波纹的基础也就是获取触发水波纹的具体坐标，是通过水波纹的扩散公式，用两张 rendertexture 分别作为 compute shader 的输入和输出来循环计算的。

流程图如下所示

![[102bce8e51c42debca43b9153ba57cce_MD5.png]]

扩散公式大致如下：

CenterHeight = OutputRT[CenterUV].x;

TopHeight = InputRT[TopUV].x;

DownHeight = InputRT[DownUV].x;

RightHeight = InputRT[RightUV].x;

LeftHeight = InputRT[LeftUV].x;

NewHeight = 外界传入信息所计算得到的高度，如果没有传入就等于 0.0

NewHeight += - (CenterHeight - 0.5) * 2.0 + ( TopHeight +DownHeight +RightHeight +LeftHeight - 2.0);

NewHeight *= 消散系数;

NewHeight = NewHeight * 0.5 + 0.5;

OutputRT[CenterUV].x = NewHeight;

在扩散公式确定之后，就要在根据外界传入参数来生成水波纹上面做文章了，最开始我们考虑了三种不同的初始波纹高度场：

l 圆形波纹：通过传入的位置，半径，强度，来为波纹 RT 生成一个离中心点越远，高度越小的高度场，因为外界之后传入的回事连续指令，那么肉眼所见的波纹就是连续的。

l 线性波纹：主要为了表现剑划过水面所产生的波纹，通过传入的入水位置和出水位置，来生成线性波纹。

l 印章类波纹：为了制作形状各异的武器砸入水里所产生的波纹，当然了，肯定能支持印章的旋转缩放。

具体效果如下视频所示，这里标注一句，最终后两种波纹都被舍弃了，下文会细说原因。

![[779d9e54a972bc44fe3dbc4445a25e4f_MD5.jpg]]

重新播放

**配置和流程**

波纹生成流程跑通之后就要考虑实际使用了。因为实时生成波纹的 RT 是有限大的，目前游戏里面使用的就是一张 2048 分辨率的 RT 来表现一块 32*32 米大小的区域，所以就用了两张备用 RT 来为原有的波纹 RT 做位移。一般选择当前控制的摄像机为焦点，如果当前帧焦点有位移，就对波纹 RT 进行位移，将位移之后的数据存入备用 RT。

流程如下图所示

![[a46bc3dacf6f4a762aa06ed90f34e867_MD5.png]]

最后将记录最新数据的 RT 传入水面 shader，根据焦点位置、波浪 RT 的分辨率、实际大小等数据，计算出波浪的法线和会导致的顶点位移并叠加到原本的水面上。

**白浪和泡沫的生成**

这一部分其实该挪到水面表现上面去的，但是目前游戏里面的水面是比较平静的，不像大海那样会出现白浪和泡沫。所以生成白浪和泡沫要用到的数据，全部可以由波浪来生成。白浪和泡沫在我理解下是两个东西，一个是在浪最汹涌的时候出现，另一个是在浪消散的时候出现。

如图所示

![[0578884ec038fba68620d1903aa99a05_MD5.png]]

具体做法是这样的：在生成波浪高度场的时候只用到了一个通道，那么第二个通道就用来存储白浪泡沫要用到的数据，这个数据遵循一个原则，这个数据全部来源于高度场数据，当生成高度场的时候，满足条件，就会存储一份相同的高度数据存储在第二个通道，然后每帧对它进行衰减，这个条件就是当前的高度场数据是大于原始第二个通道数据的。因为我想让生成白浪的数据呈一个线性变化，要么线性减弱，要么刷新重新线性减弱，而不想像波浪数据上下起伏。

有了基础数据，那么就需要配置参数对这个数据进行处理，目前是通过两套数据但是用法一模一样来处理白浪和泡沫，这个参数就是产生效果的起始点、终止点、最高点所占时间周期百分比，效果消失速率，同时因为是采样贴图制作的，所以还需要可以控制效果的 tiling，强度和亮度受法线影响。如图所示，这样就可以灵活控制白浪泡沫的生成时机。

![[5a087132668ac20f8dbf64ca9843a8c5_MD5.png]]

下面有视频来更具体的演示这个效果。

![[80bf7830f6aca45aec2393cdf2be1407_MD5.jpg]]

00:08

![[e6c9abc00ef7d6a7450adf4d7d81bd60_MD5.jpg]]

00:06

还有一种白浪，就是对于动态的静止物体，比如人物的腿。真实情况是，脚插进水里，会沿着水流方向拖出一些白浪，腿移动了之后就会很快消失。那么只需要通过水流方向传入静止物体半径、强度来生成。同时，当腿移动之后会在原始位置慢慢消失。如下图所示：

![[7b2662f8bbb812dbb00673b0157ef6ff_MD5.png]]

![[7390cd755b86c3f9ae661953b23aa974_MD5.png]]

当然了，如果是在美术同学提前放入水里的大石头或者是瀑布之下，都可以通过提前预设的一张地图大小的贴图提前刷好白浪的权重。

最后，如果水面使用了视差的效果，那么一定也要用在白浪上面。

![[b76b668ae9785be94d524251b8d99252_MD5.png]]

![[6fb031264efb80713d7d74e6ca8b68a7_MD5.jpg]]

**触发器的制作**

触发器只需要解决如下的问题，在正确的位置和正确的时间，正确地触发波纹和特效。

**正确地触发波纹**

为了达到这个目的，触发器决定以胶囊体为准通过挂接到会触发水花的物体上，比如脚掌，小腿，大腿，身体，武器等，可以通过调整胶囊体的半径、高度、轴来适配绑定的物件。接着，触发器就能获取一些必要的实时数据，比如说胶囊体本身的配置、移动速度、前一帧和当前帧的位置、前一帧和当前帧相对于水面的状态等。

有了这些数据就可以来解决实现过程的问题，第一个问题就是位置是否正确。不光是波纹触发要在正确的位置，特效触发也需要在正确的位置，所以在触发器接触水面的时候，如图所示：

![[869ea7985c19b382002c5ea42a6c58a4_MD5.png]]

就是需要计算出两根线段的交点，通过已知的数据、触发器的世界坐标、方向、高度以及水面高度就可以很容易还原出正确位置。有了正确的位置，还可以更自然的根据触发器的速度动态调整波纹强度，用 unity 自带的 animationcurve 就很容易实现一个自然的效果。

第二个，正确的时间。还记得之前说的三种波纹吗？其中的线性波纹就是在这里被舍弃的，因为它需要起始坐标和终点坐标，即使是非常快的舞剑动作也需要完成入水和出水之后才能满足条件，所以效果上就有一点延后，就不满足正确的时间。那么就只能用圆形波纹来实时表现了，于是第二个问题就来了。

因为舞剑动作太快了，也许在水下就那么 2，3 帧，但是移动的距离已经非常远，这就导致了圆形波纹不连续，其实在很多游戏里面的水波纹都有这个问题。目前我是通过记录前一帧的位置和当前帧位置进行比较，如果他们之间的路径超过了一个预定参数，比如说触发器胶囊体半径的一半，那么就自动以这个参数为距离大小来填充整个路径，这样就能补全整个路径上面连续的波纹。同时要限定一个阀值，因为卡顿的时候两帧之间距离会非常夸张，就会产生天量的波纹数据，直接可能导致波纹生成 shader 工作不正确。

这一步做了之后还是有问题，解决不了弧形路径，如下图所示：

![[1c020219af0eac15531a4269fd825ba9_MD5.jpg]]

如左图，如果触发器以蓝色方向切入水面然后以黄色方向离开水面，那么肉眼是会脑补出一个弧形移动过程的，如图上标注的理想修复路径。但是水波纹实实在在产生的路径是蓝色的实际路径，视觉上就会觉得很奇怪。同时想完美的修复理想路径是不行的，因为切出方向在切出的那一瞬间是未知的，需要未来一帧的位置才能完美算出切出的方向。

所以就用了右图的方式来修复路径，根据两个点计算出垂线方向，然后对路径进行补全，根据 animationcurve 调出来的值和移动速度来确定补全的幅度。看上去表现可能会有些问题，但是肯定比之前不不全要好，实际情况视频所示，已经符合预期了。

![[37d5f8a9910b7cd5d36710a6968eeb06_MD5.jpg]]

00:31

视频展示 -> 缓慢移动是正常的 -> 快速移动出现问题 -> 修复之后

**正确的触发特效**

接下来就是与特效的配合了，为什么需要特效？因为水波纹表现得再好，也只是在一个二维平面做文章，而添加上特效，是真的可以让出入水变得生动起来。目前特效分为大三类

l 入水

l 水中

l 出水

那么触发器就肯定需要记录触发器与水的当前帧和前一帧的状态。这三个大状态确定了，就需要确定一些细节参数。

l 速度

l 出入水角度

l 是否循环播放

l 是否动画触发

比如剑竖直插入水中和横着劈入水中，同一个角度入水但是速度不一样等，播放的特效肯定是不一样的。特效本身有循环特效和一次性特效，特效播放的时候是否需要方向（比如说剑出水，想播一个随剑甩出的特效）也需要考虑。还有一点很重要，就是角色有些动作的主观感受是速度快、力量大，但实际记录的数据并不是这样，遇到这种情况就可以通过在动画上面打标记的方式来触发。

播特效的正确位置还存在一个问题，还是拿出水来说，对于特别快的出水而言，前一帧在水下，当前帧就跑到水上很远了，那么特效的位置绝对不能在触发器上，（随剑出来的特效不算）而是在当前帧和前一帧路径与水面的交点上面。

最后是视频展示

![[8036ff00af49f6cd85e1d75ece385790_MD5.jpg]]

00:07

![[3cb4f0f87581ab3196ec825252ccb1b6_MD5.jpg]]

00:03

本篇文章简要地介绍了在完成普通水面的渲染过程中所要经历的基本流程，包括可以提升水面的真实感和层次感的一些技巧。此外，介绍了在实现水面互动上所遇到的问题、解决思路与解决方案。未来，我们也会对目前的水面进行优化，比如，水面法线会由海洋 fft 模拟出的法线代替，焦散效果将替换成真实水面波纹形变来生成。如果大家有什么想法和问题，欢迎和我们讨论。