
# 4 PBR 的优化

## 离线渲染优化

[[#5.4 预计算技术|5.4 预计算技术]] 章节提到了一些离线渲染的加速技术，除此之外，常见的离线技术还有：

*   局部静态光照烘焙
*   全局光照烘焙

还可以从以下小节中阐述的方法加速离线渲染部分。

### 积分公式优化

主要是利用 [[#5.1 微积分（Calculus）|5.1 微积分（Calculus）]] 描述的性质和定理对渲染公式进行优化：

*   常量移出积分项外
*   增加等效积分项
*   分离积分项
*   利用近似法替代复杂项

具体例子可以参看 [[#5.4 预计算技术|5.4 预计算技术]]。

###  硬件集成

将渲染通用的逻辑集成硬件指令或内建接口，可以充分利用硬件的性能，从而为渲染加速。

例如，将光线追踪算法集成进 GPU 显卡，而 nVidia 新一代 RTX20 系显卡已经集成了光线追踪技术，使得渲染效率更上一层楼。Unreal Engine 4.22 的版本也集成了这一特性。

![[1679148484069.png]]

### 并行渲染

通过多线程、多进程、多设备的架构分摊消耗的帧渲染，使得每帧的渲染时间大大降低。这种技术在实时渲染领域也逐渐被普及。

###  分布式渲染

不同于并行渲染的小规模架构，分布式渲染通常以图形工作站、集群式渲染簇等中大型硬件架构为依托，以满足电影级别的离线渲染加速需求。

下图是 [《A MultiAgent System for Physically based Rendering Optimization》](http://www.weiss-gerhard.info/publications/D02.pdf)提出的一种多代理的加速渲染架构：

![[1679148484105.png]]

## 实时渲染优化

###  光照模型优化

*   GGX 兰伯特光照计算
*   Schlick 的 $F_0$ 近似法
*   Smith 几何遮蔽函数混合
*   迪斯尼原则的金属度线性插值

以上都是本文前面章节描述过的加速算法，这对于性能敏感的实时渲染领域是非常有必要的。

### 资源优化

*   若干贴图合成一张蒙板图。将若干独立的 PBR 属性蒙板贴图合成一张：
    
    ![[1679148484125.png]]
    
    _使用同一张蒙板贴图同时控制 PBR 的颜色、金属度、粗糙度等属性。_
    
*   减少 PBR 标准参数的使用。例如，金属材质的漫反射大部分是黑色，所以无需额外的漫反射贴图。
    
*   其它资源优化：材质、模型、渲染参数、纹理、PBR 参数等等几乎都有优化的余地。
    

### 其它实时优化

实时渲染领域还有很多优化方法值得尝试和应用，比如：

*   [《Moving Frostbite to PBR》](https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf)提出的 IES 光照模拟。
    ![[1679148484162.png]]
    
*   [《Applying Visual Analytics to Physically-Based Rendering》](http://cg.ivd.kit.edu/publications/2018/visual_analytics_pbr/preprint.pdf)提出的可视化分析优化。
    
    ![[1679148484238.png]]
    

###  移动端优化

由于移动设备普遍的性能与 PC 机有一定的差距，所以要将 PBR 应用到移动端，性能优化的需求更加迫切。

上一小节提到的实时渲染优化同样适用于移动端，此外，还可针对移动端做一些特殊的优化：

*   简化光照模型。采用更少的样本采样数量，更简化的光照计算公式。
*   简化 shader。通过少量的 shader 指令或简化的数学运算可达到优化的目的。
*   启用引擎 Mobile 版本的资源和设置。Unity 和 Unreal Engine 都提供了移动版本的材质库和特殊的配置，在无特别需求下，尽量使用它们。
*   分级策略。针对不同分级的设备启用不同复杂度的材质和资源，可以有效解决高中低画质的兼容问题。

更多请参看 [《Optimizing PBR》](https://community.arm.com/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-20-66/siggraph2015_2D00_mmg_2D00_renaldas_2D00_slides.pdf)，还可参看笔者的另外一篇原创技术文章：[**《移动游戏性能优化通用技法》**](https://www.cnblogs.com/timlly/p/10463467.html)
